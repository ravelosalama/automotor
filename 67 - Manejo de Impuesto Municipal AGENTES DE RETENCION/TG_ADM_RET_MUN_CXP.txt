--- TRIGGER QUE GENERAL EL REGISTRO DE RETENCION MUNICIPAL  EN CXP  
--- Y GESTIONA TODO LO RELATIVO AL MANEJO DE ESTE IMPUESTO
--- ELABORADO POR: JOSE RAVELO AGOSTO 2010

DROP TRIGGER  [TG_ADM_RET_MUN_CXP] 
GO

CREATE TRIGGER [TG_ADM_RET_MUN_CXP] ON [dbo].[SAACXP] 
FOR INSERT  
AS

DECLARE @CODPROV VARCHAR(15)
DECLARE @NROUNICO INT
DECLARE @NROUNI10 INT
DECLARE @NROREGI INT
DECLARE @FECHAE DATETIME
DECLARE @FECHAV DATETIME
DECLARE @CODSUCU VARCHAR(5)
DECLARE @CODESTA VARCHAR(10)
DECLARE @CODUSUA VARCHAR(10)
DECLARE @CODOPER VARCHAR(10)
DECLARE @NUMEROD VARCHAR(20)
DECLARE @NROCTROL VARCHAR(20)
DECLARE @FROMTRAN INT
DECLARE @TIPOCXP VARCHAR(2)
DECLARE @FACTOR INT
DECLARE @MONTOMEX DECIMAL(23,2)
DECLARE @SALDOMEX DECIMAL(23,2)
DECLARE @DOCUMENT VARCHAR(60)
DECLARE @MONTO DECIMAL(23,2)
DECLARE @MONTONETO DECIMAL (23,2)
DECLARE @MTOTAX DECIMAL (23,2)
DECLARE @RETENIVA DECIMAL(23,2)
DECLARE @ORGTAX INT
DECLARE @SALDO INT
DECLARE @SALDOACT INT
DECLARE @ESLIBRO INT
DECLARE @BASEIMPO DECIMAL (23,2)
DECLARE @FECHAI DATETIME
DECLARE @FECHAR DATETIME
DECLARE @FECHAT DATETIME
DECLARE @NUMERON VARCHAR(20)
DECLARE @DESCRIP VARCHAR(60)
DECLARE @TEXENTO DECIMAL (23,2)

 
SELECT  @CODPROVE=CODPROV,
        @FECHAE=FECHAE,
        @FECHAR=FECHAR,
        @FECHAV=FECHAV,
        @FECHAT=FECHAT,
        @FECHAI=FECHAI,
        @NUMEROD=NUMEROD,
        @NUMERON=NUMEROR,
        @DOCUMENT='DEV.'+@NUMEROD+'/ F.AFEC:'+@NUMERON,
        @MONTO=MTOTOTAL,
        @MTOTAX=MTOTAX,
        @BASEIMPO=TGRAVABLE,
        @TEXENTO=TEXENTO,
        @CODOPER=CODOPER,
        @CODSUCU=CODSUCU,
        @CODESTA=CODESTA,
        @CODUSUA=CODUSUA,
        @CODVEND=CODVEND,
        @NROCTROL=NROCTROL,
        @TIPOFAC=TIPOFAC,
        @CREDITO=CREDITO,
        @MONTONETO=TEXENTO+TGRAVABLE
       

FROM INSERTED

SELECT @NROREGI=NROUNICO, @FECHAO=FECHAE FROM SAACXC WHERE NUMEROD=@NUMERON AND TIPOCXC='10'AND CODCLIE=@CODCLIE

IF @TIPOCXP=81 AND @MUNICIPAL=1

     BEGIN
 
          INSERT INTO SAACXC  (CODCLIE, FECHAE, FECHAV, CODSUCU, CODESTA, CODUSUA, CODOPER, CODVEND, NUMEROD, NROCTROL, FROMTRAN,
                               TIPOCXC, DOCUMENT, MONTO, MONTONETO, MTOTAX, ESLIBROI, BASEIMPO, AFECTAVTA, AFECTACOMI, FECHAI,
                               NUMERON, TEXENTO, FECHAT )
 
          SELECT               @CODCLIE, @FECHAE, @FECHAE, @CODSUCU, @CODESTA, @CODUSUA, @CODOPER, @CODVEND, @NUMEROD, @NUMEROD, 0,
                               '41', @DOCUMENT, @MONTO, @MONTONETO, @MTOTAX, 0, @BASEIMPO,0, 0, @FECHAE, 
                               @NUMERON, @TEXENTO, @FECHAE
   
          UPDATE  SAACXC
          SET SALDO = SALDO - @MONTO
          WHERE  NUMEROD=@NUMERON AND TIPOCXC='10' AND CODCLIE=@CODCLIE

          SELECT @NROUNICO=NROUNICO FROM SAACXC WHERE NUMEROD=@NUMEROD AND TIPOCXC='31' AND CODCLIE=@CODCLIE

          INSERT INTO SAPAGCXC  (NROPPAL, NROREGI,TIPOCXC,MONTODOCA,MONTO,NUMEROD,DESCRIP,FECHAE,FECHAO,BASEIMPO,MTOTAX,TEXENTO)
 
          SELECT @NROUNICO, @NROREGI,'10', @MONTO, @MONTO,@NUMERON,@DOCUMENT, @FECHAE,@FECHAO, @BASEIMPO, @MTOTAX, @TEXENTO
          
   END    
 

