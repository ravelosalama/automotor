 -- ************************************************************************************
-- TRIGGER PARA REVERSAR TRANSACCIONES EN CXC DESDE ELIMINACION DE TRANSACCION EN BANCO 
-- SOLO CUANDO VIENE DE CXC/ANTICIPO
-- *************************************************************************************
-- ************************** JOSE RAVELO OCT-2009 *************************************
DROP TRIGGER TG_REVERSO_ANTICIPO_CXC_BANCO
GO
CREATE TRIGGER [TG_REVERSO_ANTICIPO_CXC_BANCO] ON [dbo].[SBTRAN] 
WITH ENCRYPTION
FOR DELETE
AS
 
 

DECLARE @CODCLIE VARCHAR(10)
DECLARE @USUARIO VARCHAR(10)
DECLARE @RESULTADO VARCHAR(35)
DECLARE @NROUNICO INT 
DECLARE @NROREGI  INT
DECLARE @NROPPAL  INT
DECLARE @NOPE     INT
DECLARE @CDCD     INT
DECLARE @TDC      INT
DECLARE @ESTADO   INT
DECLARE @DOCUMENTO VARCHAR(20)
DECLARE @SALDO DECIMAL(23,2)
DECLARE @CODOPER VARCHAR(10)
DECLARE @RETENCION VARCHAR(14)
DECLARE @FECHA DATETIME
DECLARE @MONTO DECIMAL(23,2)
DECLARE @NUMERON VARCHAR(15)
DECLARE @NUMEROD VARCHAR(15)
DECLARE @DESCRIPERROR VARCHAR(100)
DECLARE @STATUSERROR INT
DECLARE @OBCP VARCHAR(2)
 
 
BEGIN

SET @RESULTADO = 'SOLICITUD NO PROCEDENTE'
SET @STATUSERROR=0
SET @DESCRIPERROR =  ''

SELECT @DOCUMENTO=DOCUMENTO,
       @NOPE=NOPE,
       @NROPPAL=NROPPAL,
       @CDCD=CDCD,
       @TDC=TDC,
       @ESTADO=ESTADO,
       @OBCP=OBCP
FROM DELETED 


 -- Valida SI LA TRANSACCION ESTA PRECONCILIADA
     IF  @ESTADO<>0

        BEGIN
         SET @STATUSERROR=1
         SET @DESCRIPERROR='NO PUEDE ELIMINAR TRANSACCIONES PRECONCILIADAS, DESCONCILIAR E INTENTE DE NUEVO'             
        END 

 -- MUESTRA PANTALLA CON RESULTADO DE VALIDACIONES SI LAS HAY.

   IF @STATUSERROR=1
   BEGIN
      RAISERROR (@DESCRIPERROR,16,1)
      ROLLBACK TRANSACTION
      RETURN
   END

-- VALIDACIONES Y PROCESO

-- CASO (ELIMINACION DE DEPOSITO EN TRANSITO DESDE CXC ENLAZADO CON NROPPAL/NROUNICO-CXC

     IF @CDCD=1 AND @ESTADO=0 AND @OBCP='C' AND @NROPPAL<>0
         
       BEGIN
        DELETE FROM SAACXC WHERE NROUNICO=@NROPPAL
             
        DELETE FROM SBDIFE WHERE NOPE=@NOPE
        DELETE FROM SBDTRN WHERE NOPE=@NOPE
       END
END



















