 -- ********************************************************************************
-- TRIGGER PARA PROCESAR MODIFICACION PARCIAL EN DATOS DE VENTAS
-- ********************************************************************************
-- ************************** JOSE RAVELO MAR-2009 ********************************
DROP TRIGGER MODIFICA_VENTAS
GO

CREATE TRIGGER [MODIFICA_VENTAS] ON [dbo].[SACLIE_06] 
WITH ENCRYPTION
FOR INSERT, UPDATE 
AS 

DECLARE @CODCLIE VARCHAR(10)
DECLARE @USUARIO VARCHAR(10)
DECLARE @TIPOFAC VARCHAR(2)
DECLARE @NROUNICO INT 
DECLARE @NROREGI INT
DECLARE @NROPPAL INT
DECLARE @SALDO DECIMAL(23,2)
DECLARE @CODOPER VARCHAR(10)
DECLARE @FECHA DATETIME
DECLARE @MONTO DECIMAL(23,2)
DECLARE @NUMERON VARCHAR(15)
DECLARE @NUMEROD VARCHAR(15)
DECLARE @EXENTO DECIMAL(23,2)
DECLARE @BASEI  DECIMAL(23,2)
DECLARE @ALICUOTA  DECIMAL(23,2)
DECLARE @SIGNO INT
DECLARE @RESULTADO VARCHAR(35)

 
-- VALIDAR EXISTENCIA DE USUARIO QUE SOLICITA LA ELIMINACION AL MENOS EXISTENCIA A SAUSUario

BEGIN
 

SELECT @CODCLIE=CODCLIE, 
       @USUARIO=USUARIO, 
       @NUMEROD=DOCUMENTO, 
       @TIPOFAC=TIPO_DE_DOCUMENTO,    
       @BASEI=BASE_IMPONIBLE,
       @ALICUOTA=ALICUOTA,
       @EXENTO=ISNULL(EXENTO,0), 
       @SALDO=SALDO

FROM INSERTED 

SET @RESULTADO = 'SOLICITUD NO PROCEDENTE'

IF EXISTS (SELECT * FROM SAFACT WHERE CODCLIE=@CODCLIE AND NUMEROD=@NUMEROD AND TIPOFAC= @TIPOFAC) 

  IF @TIPOFAC='A' 

   BEGIN
        
       UPDATE SAFACT   SET MONTO=@BASEI, TGRAVABLE=@BASEI, TEXENTO=@EXENTO, MTOTAX=@BASEI*@ALICUOTA/100 WHERE NUMEROD=@NUMEROD AND TIPOFAC='A'
       UPDATE SATAXVTA SET MONTO=@BASEI*@ALICUOTA/100, TGRAVABLE=@BASEI, MTOTAX=@ALICUOTA WHERE NUMEROD=@NUMEROD AND TIPOFAC='A'
       UPDATE SAACXC   SET MONTO=@BASEI+@EXENTO+@BASEI*@ALICUOTA/100, MONTONETO=@BASEI+@EXENTO, MTOTAX=@BASEI*@ALICUOTA/100, ORGTAX=@BASEI*@ALICUOTA/100, SALDO=@SALDO,TEXENTO=@EXENTO, BASEIMPO=@BASEI WHERE @CODCLIE=CODCLIE AND NUMEROD=@NUMEROD AND TIPOCXC='10'
       SET @RESULTADO = 'DATOS DE FACTURA ACTUALIZADOS'

 
   END

  IF  @TIPOFAC='B'
 
   BEGIN
    
       SELECT @SIGNO=SIGNO FROM SAFACT WHERE NUMEROD=@NUMEROD AND TIPOFAC='B'
       UPDATE SAFACT   SET MONTO=@BASEI, TGRAVABLE=@BASEI, TEXENTO=@EXENTO, MTOTAX=@BASEI*@ALICUOTA/100 WHERE NUMEROD=@NUMEROD AND TIPOFAC='B'
       UPDATE SATAXVTA SET MONTO=@EXENTO+@BASEI*@ALICUOTA/100, TGRAVABLE=@BASEI, MTOTAX=@ALICUOTA WHERE NUMEROD=@NUMEROD AND TIPOFAC='B'
       UPDATE SAACXC   SET MONTO=@BASEI+@EXENTO+@BASEI*@ALICUOTA/100, MONTONETO=@BASEI+@EXENTO, MTOTAX=@BASEI*@ALICUOTA/100, ORGTAX=@BASEI*@ALICUOTA/100, SALDO=0,TEXENTO=@EXENTO, BASEIMPO=@BASEI WHERE @CODCLIE=CODCLIE AND NUMEROD=@NUMEROD AND TIPOCXC='31'
            
       SET @RESULTADO = 'DATOS DE DEVOLUCION ACTUALIZADOS'

   END

 END
-- UPDATE SACLIE_06 SET RESULTADO=@RESULTADO WHERE CODCLIE=@CODCLIE AND DOCUMENTO=@NUMEROD AND TIPO_DE_DOCUMENTO=@TIPOFAC


