-- TRIGGER VIGENTE EN EXCELENT AL 18/10/2014 SE ELIMINAN LOS TRIGGER SOBRE SAIPAGVTA Y SAIPAPAGCXC
-- EL REPORTE DE VENTAS LEE EN SUBREPORTE LA TABLA SASE_RETIVACXC.NROREGI = NROREGI.SACXC TIPOCXC='81' PARA RETENCIONES DE FACT MESES ANTERIORES.
-- 
--
--
--




DROP TRIGGER  [ACTUALIZA RETENIVA SAACXC] 
GO

CREATE TRIGGER [ACTUALIZA RETENIVA SAACXC] ON [dbo].[SAACXC] 
FOR INSERT  
AS

DECLARE @monto DECIMAL(23,2)
DECLARE @nroREGI  INT
DECLARE @NROUNICO INT
DECLARE @codOPER VARCHAR(10)
DECLARE @FACTURA VARCHAR(10)
DECLARE @tipoCXC VARCHAR(2)
DECLARE @fechapago DATETIME
DECLARE @fechaFACT DATETIME
DECLARE @FECHARETE DATETIME
DECLARE @FECHAHOY  DATETIME
DECLARE @comprobante VARCHAR(20)

SELECT @monto = monto,
       @nroREGI=nroREGI,
       @NROUNICO=NROUNICO, 
       @CODOPER=CODOPER, 
       @TIPOCXC=TIPOCXC,
       @COMPROBANTE=NUMEROT,
       @FACTURA=NUMERON,
       @FECHAPAGO=FECHAI,
       @FECHARETE=FECHAE,
       @FECHAFACT=FECHAR

 FROM INSERTED



IF @codOPER='04-002' AND @TIPOCXC='81'

  BEGIN      

       IF (YEAR(@FECHAPAGO) = YEAR(@FECHAFACT)) AND (MONTH(@FECHAPAGO) = MONTH(@FECHAFACT))

               -- CASO 1 (COBRANZA DE FACTURA MISMO MES)
               UPDATE SAFACT
               SET RETENIVA = @MONTO, NOTAS9=@COMPROBANTE
               WHERE  SAFACT.NUMEROD=@FACTURA AND SAFACT.TIPOFAC='A'

       ELSE
   
                BEGIN
                -- CASO 2 (COBRANZA DE FACTURA MES ANTERIOR)
                 INSERT INTO SASE_RETIVACXC (NROPPAL,FECHAPAGO,NUMEROD,MONTO)
                 SELECT @nroUNICO,@fechapago,@FACTURA,@monto   
                 -- ADM/CXC/POA/ EN DETALLE DEL DOCUMENTO REGISTRAR NO. COMPROBANTE
                END

  END



