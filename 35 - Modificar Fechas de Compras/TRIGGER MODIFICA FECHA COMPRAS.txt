-- **************** TRIGGERS MODIFICA_FECHAS_EN_COMPRAS ***************************
--
-- ********************************************************************************
-- ***************** JOSE RAVELO MAR-2008 *****************************************
-- ESTE TRIGGER ACTUALIZA LOS REGISTROS DE LAS TABLAS DE COMPRAS QUE ALMACENAN FECHAS DE POSTEO 
-- Y FECHA REAL DEL UN DOCUMENTO EN FUNCION A LO INDICADO EN DATOS ADICIONALES DE LA TABLA SAPROV_04 
-- GESTIONADO POR ADMINISTRATIVO/PROVEEDOR.

DROP TRIGGER [MODIFICA_FECHAS_EN_COMPRAS]
GO

CREATE TRIGGER [MODIFICA_FECHAS_EN_COMPRAS] ON [dbo].[SAPROV_04] 
WITH ENCRYPTION
FOR INSERT, UPDATE 
AS

DECLARE @CODPROV VARCHAR(15)
DECLARE @USUARIO VARCHAR(35)
DECLARE @COMPRA VARCHAR(15)
DECLARE @FREGINEW DATETIME
DECLARE @FREALNEW DATETIME 
DECLARE @RESULTADO VARCHAR(35)
DECLARE @NUINSERTED INT 
DECLARE @NUSAACXP INT

BEGIN
SELECT @NUINSERTED=NROUNICO, @CODPROV=CODPROV, @USUARIO=USUARIO, @COMPRA=COMPRA,
       @FREGINEW=FECHA_REGISTRO_NUEVA, @FREALNEW=FECHA_REAL_NUEVA FROM INSERTED

IF EXISTS (SELECT * FROM SACOMP WHERE (NUMEROD=@COMPRA AND CODPROV=@CODPROV AND TIPOCOM='H'))
   BEGIN

      SELECT @NUSAACXP=NROUNICO FROM SAACXP WHERE (NUMEROD=@COMPRA AND CODPROV=@CODPROV AND TIPOCXP='10')
       
      UPDATE SAACXP SET FECHAE=@FREALNEW, FECHAI=@FREGINEW WHERE (NUMEROD=@COMPRA AND CODPROV=@CODPROV AND TIPOCXP='10')
      UPDATE SACOMP SET FECHAE=@FREGINEW, FECHAI=@FREALNEW WHERE (NUMEROD=@COMPRA AND CODPROV=@CODPROV AND TIPOCOM='H')
    --  UPDATE SACOMP_01 SET FECHA_REAL=@FREALNEW WHERE (NUMEROD=@COMPRA AND CODPROV=@CODPROV AND TIPOCOM='H')
      UPDATE SAACXP SET FECHAE=@FREGINEW, FECHAI=@FREALNEW WHERE NROREGI=@NUSAACXP

      SET @RESULTADO = 'FECHAS CAMBIADAS SATISFACTORIAMENTE'
  
   END
   ELSE
   BEGIN
      SET @RESULTADO = 'COMPRA A MODIFICAR NO EXISTE EN BD'
   END 

UPDATE SAPROV_04 SET RESULTADO=@RESULTADO WHERE NROUNICO=@NUINSERTED
END